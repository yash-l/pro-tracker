import os, sys, asyncio, secrets, logging, io, csv, time, glob, json
from telethon import TelegramClient, errors
from telethon.sessions import StringSession
from telethon.tl.types import UserStatusOnline, InputPhoneContact
from telethon.tl.functions.contacts import ImportContactsRequest
from quart import Quart, render_template_string, request, redirect, session, Response, url_for
import aiosqlite
import python_socks
import hypercorn.asyncio
from hypercorn.config import Config
import pytz
import httpx
from datetime import datetime

# --- CONFIGURATION (Render Friendly) ---
API_ID = int(os.environ.get("API_ID", 9497762))
API_HASH = os.environ.get("API_HASH", "272c77bf080e4a82846b8ff3dc3df0f4")
SESSION_STRING = os.environ.get("SESSION_STRING", None)
AUTO_TARGETS = os.environ.get("AUTO_TARGETS", "") 

DB_FILE = 'tracker.db'
PIC_FOLDER = 'static/profile_pics'
POLL_INTERVAL = 10
SELF_PING_URL = os.environ.get("RENDER_EXTERNAL_URL", "http://localhost:5000")

os.makedirs(PIC_FOLDER, exist_ok=True)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger("Tracker")

app = Quart(__name__, static_folder='static')
app.secret_key = secrets.token_hex(16)

# Locks & Semaphores
db_lock = asyncio.Lock()
api_sem = asyncio.Semaphore(5)

class AppState:
    def __init__(self):
        self.client = None
        self.db = None
        self.tg_logged_in = False
        self.status = "Initializing..."
        self.memory = {} 
        self.running = True

state = AppState()

# --- DATABASE ---
async def init_db():
    state.db = await aiosqlite.connect(DB_FILE)
    state.db.row_factory = aiosqlite.Row
    await state.db.execute('CREATE TABLE IF NOT EXISTS targets (id INTEGER PRIMARY KEY, user_id INT UNIQUE, name TEXT, status TEXT, last_seen REAL, pic TEXT)')
    await state.db.execute('CREATE TABLE IF NOT EXISTS sessions (id INTEGER PRIMARY KEY, user_id INT, status TEXT, start REAL, end REAL, dur TEXT)')
    await state.db.execute('CREATE TABLE IF NOT EXISTS app_config (key TEXT PRIMARY KEY, value TEXT)')
    
    # Default Web Admin Credentials
    if not await db_query("SELECT value FROM app_config WHERE key='admin_user'", fetch="val"):
        await db_query("INSERT INTO app_config VALUES ('admin_user', 'admin')", commit=True)
        await db_query("INSERT INTO app_config VALUES ('admin_pass', 'admin')", commit=True)
    
    await state.db.commit()
    logger.info("‚úÖ Database initialized")

async def db_query(sql, args=(), commit=False, fetch="all"):
    if not state.db: return None
    async with db_lock:
        try:
            cursor = await state.db.execute(sql, args)
            if commit: await state.db.commit()
            if fetch == "one": return await cursor.fetchone()
            if fetch == "all": return await cursor.fetchall()
            if fetch == "val": 
                res = await cursor.fetchone()
                return res[0] if res else None
        except Exception as e:
            logger.error(f"DB Error: {e}")
            return None

# --- HELPERS ---
def format_ts(ts, minimal=True):
    if not ts: return "Never"
    try:
        dt = datetime.fromtimestamp(ts, pytz.timezone('Asia/Kolkata'))
        now = datetime.now(pytz.timezone('Asia/Kolkata'))
        if minimal and dt.date() == now.date():
            return dt.strftime('%I:%M %p')
        return dt.strftime('%d-%b %I:%M %p')
    except: return "-"

def calc_dur(start_ts, end_ts):
    try:
        if not start_ts or not end_ts: return "-"
        seconds = int(end_ts - start_ts)
        if seconds < 60: return "Just now"
        m, s = divmod(seconds, 60)
        h, m = divmod(m, 60)
        if h > 0: return f"{h}h {m}m"
        return f"{m}m {s}s"
    except: return "-"

async def get_chart_data(uid):
    """Generates hourly data for Chart.js"""
    hourly = [0] * 24
    rows = await db_query("SELECT start FROM sessions WHERE user_id = ? ORDER BY id DESC LIMIT 100", (uid,))
    if rows:
        for r in rows:
            try:
                dt = datetime.fromtimestamp(r['start'], pytz.timezone('Asia/Kolkata'))
                hourly[dt.hour] += 1
            except: pass
    return hourly

async def get_insight(uid):
    hourly = await get_chart_data(uid)
    if sum(hourly) == 0: return "No sufficient data yet."
    peak_hour = hourly.index(max(hourly))
    dt = datetime.now().replace(hour=peak_hour, minute=0)
    return f"Most active around {dt.strftime('%I %p')}"

async def safe_api_call(coroutine):
    async with api_sem:
        try:
            return await coroutine
        except errors.FloodWaitError as e:
            logger.warning(f"üåä FloodWait: Sleeping {e.seconds}s...")
            await asyncio.sleep(e.seconds)
            return await safe_api_call(coroutine)
        except Exception: return None

async def download_pic(user):
    try:
        if state.client and state.client.is_connected():
            p = await state.client.download_profile_photo(user, file=PIC_FOLDER)
            return os.path.basename(p) if p else "default.png"
    except: pass
    return "default.png"

# --- CORE ENGINE ---
async def init_client():
    sess_str = await db_query("SELECT value FROM app_config WHERE key='tg_session'", fetch="val")
    # Fallback to Env Var (for Render Persistence)
    if not sess_str: sess_str = os.environ.get("SESSION_STRING", None)

    if sess_str:
        try:
            state.client = TelegramClient(StringSession(sess_str), API_ID, API_HASH)
            await state.client.connect()
            if await state.client.is_user_authorized():
                state.tg_logged_in = True
                state.status = "Active"
                logger.info("‚úÖ Telegram Connected")
        except: pass
    
    if not state.client:
        state.client = TelegramClient(StringSession(), API_ID, API_HASH)
        await state.client.connect()

async def restore_targets():
    if not state.tg_logged_in or not AUTO_TARGETS: return
    for t in [x.strip() for x in AUTO_TARGETS.split(',') if x.strip()]:
        await add_target_logic(t)

async def add_target_logic(u):
    try:
        e = None
        # Safe Resolve (Username/ID only)
        try: e = await safe_api_call(state.client.get_entity(int(u) if u.lstrip('-').isdigit() else u))
        except: pass
        
        if e:
            pic = await download_pic(e)
            name = getattr(e, 'first_name', '') or getattr(e, 'username', '') or str(u)
            if getattr(e, 'last_name', None): name += f" {e.last_name}"
            
            await db_query('INSERT OR IGNORE INTO targets (user_id, name, status, last_seen, pic) VALUES (?,?,?,?,?)', (e.id, name, '...', time.time(), pic), commit=True)
    except: pass

async def tracker_loop():
    while not state.tg_logged_in:
        state.status = "Waiting for Telegram Login..."
        await asyncio.sleep(2)
    
    await restore_targets()
    state.status = "Monitoring"
    logger.info("üöÄ Tracker V36 Engine Started")
    last_flush = time.time()

    while state.running:
        try:
            if not state.client or not state.client.is_connected():
                await state.client.connect()
                await asyncio.sleep(5); continue

            targets = await db_query('SELECT user_id, name FROM targets')
            if not targets: await asyncio.sleep(POLL_INTERVAL); continue

            for t in targets:
                uid, name = t['user_id'], t['name']
                try:
                    u = await safe_api_call(state.client.get_entity(uid))
                    if not u: continue 
                    
                    is_online = isinstance(u.status, UserStatusOnline)
                    stat = 'online' if is_online else 'offline'
                    now_ts = time.time()

                    if stat != state.memory.get(uid):
                        await db_query('UPDATE targets SET status=?, last_seen=? WHERE user_id=?', (stat, now_ts, uid), commit=True)
                        
                        if stat == 'online':
                            await db_query('INSERT INTO sessions (user_id, status, start) VALUES (?,?,?)', (uid, 'ONLINE', now_ts), commit=True)
                            await safe_api_call(state.client.send_message('me', f"üü¢ <b>{name}</b> is ONLINE", parse_mode='html'))
                        
                        elif state.memory.get(uid) == 'online':
                            last_sess = await db_query('SELECT id, start FROM sessions WHERE user_id=? AND end IS NULL ORDER BY id DESC LIMIT 1', (uid,), fetch="one")
                            if last_sess:
                                dur = calc_duration(last_sess['start'], now_ts)
                                await db_query('UPDATE sessions SET end=?, dur=? WHERE id=?', (now_ts, dur, last_sess['id']), commit=True)
                        
                        state.memory[uid] = stat
                    
                    elif time.time() - last_flush > 300: # Heartbeat every 5 mins
                        await db_query('UPDATE targets SET last_seen=? WHERE user_id=?', (now_ts, uid), commit=True)
                        
                except: pass
                await asyncio.sleep(0.1)
            
            if time.time() - last_flush > 300: last_flush = time.time()
            await asyncio.sleep(POLL_INTERVAL)
            
        except Exception as e:
            logger.error(f"Loop Crash: {e}")
            await asyncio.sleep(POLL_INTERVAL)

async def keep_alive():
    while state.running:
        await asyncio.sleep(600)
        try: async with httpx.AsyncClient() as h: await h.get(SELF_PING_URL)
        except: pass

# --- GOD MODE UI TEMPLATES ---
STYLE = """
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    * { box-sizing: border-box; }
    body { background: #0f172a; font-family: 'Inter', sans-serif; margin: 0; padding: 0; color: white; display: flex; flex-direction: column; min-height: 100vh; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
    .auth-card { padding: 40px; border-radius: 24px; width: 100%; max-width: 400px; }
    .title { text-align: center; font-size: 1.8rem; font-weight: 800; margin-bottom: 30px; background: linear-gradient(to right, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .input { width: 100%; padding: 15px; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; color: white; margin-bottom: 20px; font-size: 16px; outline:none; transition:0.3s; }
    .input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    .btn { width: 100%; padding: 15px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; transition:0.2s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
    .nav { position: sticky; top: 0; z-index: 50; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
    .container { padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px 0; }
    .card { border-radius: 20px; padding: 20px; transition: 0.3s; position: relative; overflow: hidden; }
    .card:hover { transform: translateY(-5px); border-color: #3b82f6; }
    .avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid #334155; }
    .avatar.online { border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
    .status-badge { font-size: 0.7rem; font-weight: 800; padding: 5px 12px; border-radius: 20px; background: #334155; display: inline-block; letter-spacing: 0.5px; }
    .status-badge.online { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .fab { position:fixed; bottom:30px; right:30px; background:#3b82f6; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:white; text-decoration:none; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5); transition: 0.3s; z-index: 100; }
    .fab:hover { transform: scale(1.1) rotate(90deg); }
    .menu-link { color: #94a3b8; margin-left: 20px; font-size: 1.2rem; transition: 0.2s; }
    .menu-link:hover { color: white; }
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
"""

P_LOGIN = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="auth-container"><div class="glass auth-card">
    <div class="title"><i class="fa-solid fa-shield-halved"></i> Admin Access</div>
    {% if error %}<div style="color:#f87171; text-align:center; margin-bottom:15px;">{{ error }}</div>{% endif %}
    <form action="/do_web_login" method="post">
        <input type="text" name="username" class="input" placeholder="Username" required>
        <input type="password" name="password" class="input" placeholder="Password" required>
        <button class="btn">Unlock Dashboard</button>
    </form>
</div></div></body></html>"""

P_TG_CONNECT = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="auth-container"><div class="glass auth-card">
    <div class="title"><i class="fa-brands fa-telegram"></i> Connect Engine</div>
    <p style="text-align:center; color:#94a3b8; margin-bottom:30px;">Enter your phone number to initialize the tracking bot.</p>
    <form action="/send_otp" method="post">
        <input type="text" name="ph" class="input" placeholder="+91..." required>
        <button class="btn" style="background:#0ea5e9">Send OTP</button>
    </form>
</div></div></body></html>"""

P_TG_VERIFY = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="auth-container"><div class="glass auth-card">
    <div class="title">üîê Verify Access</div>
    <p style="text-align:center; color:#94a3b8; margin-bottom:30px;">Check your Telegram app for the code.</p>
    <form action="/verify_otp" method="post">
        <input type="hidden" name="ph" value="{{ ph }}">
        <input type="hidden" name="hash" value="{{ hash }}">
        <input type="hidden" name="session_str" value="{{ session_str }}">
        <input type="text" name="code" class="input" placeholder="1 2 3 4 5" style="text-align:center; letter-spacing:8px; font-size:1.2rem;" required>
        <button class="btn" style="background:#10b981">Start Engine</button>
    </form>
</div></div></body></html>"""

P_DASH = """<!DOCTYPE html><html><head>""" + STYLE + """<meta http-equiv="refresh" content="{{ refresh }}"></head><body>
<div class="nav glass">
    <div style="font-weight:800; font-size:1.2rem; background:linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
        <i class="fa-solid fa-radar"></i> ProTracker
    </div>
    <div>
        <a href="/profile" class="menu-link"><i class="fa-solid fa-gear"></i></a>
        <a href="/logout" class="menu-link" style="color:#ef4444;"><i class="fa-solid fa-power-off"></i></a>
    </div>
</div>
<div class="container">
    {% if not tg_active %}
    <a href="/connect_telegram" style="display:block; background:rgba(245, 158, 11, 0.1); border:1px solid rgba(245, 158, 11, 0.5); color:#fbbf24; padding:15px; border-radius:12px; text-align:center; text-decoration:none; font-weight:bold; margin-bottom:20px; backdrop-filter:blur(5px);">
        <i class="fa-solid fa-triangle-exclamation"></i> Tracker Engine Disconnected. Click to Reconnect.
    </a>
    {% endif %}
    
    <div class="grid">
        {% for t in targets %}
        <a href="/target/{{ t.user_id }}" style="text-decoration:none; color:inherit;">
            <div class="glass card">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img src="/static/profile_pics/{{ t.pic }}" class="avatar {{ 'online' if t.status == 'online' else '' }}" onerror="this.src='/static/profile_pics/default.png'">
                    <div>
                        <div style="font-weight:700; font-size:1.1rem;">{{ t.name }}</div>
                        <div class="status-badge {{ 'online' if t.status == 'online' else '' }}">{{ t.status.upper() }}</div>
                    </div>
                </div>
                <div style="margin-top:20px; display:flex; justify-content:space-between; font-size:0.85rem; color:#94a3b8; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px;">
                    <span><i class="fa-regular fa-clock"></i> Last Seen</span>
                    <span style="color:white; font-family:monospace;">{{ t.last_seen_fmt }}</span>
                </div>
            </div>
        </a>
        {% else %}
        <div style="grid-column:1/-1; text-align:center; padding:60px; color:#64748b;">
            <i class="fa-solid fa-ghost" style="font-size:3rem; margin-bottom:20px; opacity:0.5;"></i><br>
            No targets found. Tap the + button to add one.
        </div>
        {% endfor %}
    </div>
</div>
<a href="/add_page" class="fab"><i class="fa-solid fa-plus"></i></a>
</body></html>"""

P_DETAIL = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="nav glass">
    <a href="/" style="color:white; text-decoration:none; font-weight:600;"><i class="fa-solid fa-arrow-left"></i> Back</a>
</div>
<div class="container">
    <div class="glass card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px;">
        <div style="display:flex; align-items:center; gap:20px;">
            <img src="/static/profile_pics/{{ t.pic }}" class="avatar" style="width:80px; height:80px; border-radius:20px;" onerror="this.src='/static/profile_pics/default.png'">
            <div>
                <h1 style="margin:0; font-size:1.8rem; font-weight:800;">{{ t.name }}</h1>
                <div style="color:#94a3b8; font-family:monospace; margin-top:5px;">ID: {{ t.user_id }}</div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
             <a href="/export/{{ t.user_id }}" class="btn" style="width:auto; display:inline-block; padding:12px 20px; background:#10b981;"><i class="fa-solid fa-download"></i> CSV</a>
             <a href="/delete/{{ t.user_id }}" class="btn" style="width:auto; display:inline-block; padding:12px 20px; background:#ef4444;" onclick="return confirm('Stop tracking this user?')"><i class="fa-solid fa-trash"></i></a>
        </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="glass card">
            <h3 style="color:#94a3b8; font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">AI Insight</h3>
            <div style="font-size:1.1rem; color:#60a5fa; font-weight:600;"><i class="fa-solid fa-lightbulb"></i> {{ insight }}</div>
        </div>
        <div class="glass card">
            <h3 style="color:#94a3b8; font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">Current Status</h3>
            <div style="font-size:1.1rem; font-weight:600; color: {{ '#4ade80' if t.status=='online' else '#94a3b8' }}">{{ t.status.upper() }}</div>
        </div>
    </div>

    <div class="glass card" style="margin-top:0;">
        <h3 style="margin-top:0; margin-bottom:20px;">Activity Heatmap (Himport os, sys, asyncio, secrets, logging, io, csv, time, glob, json
from telethon import TelegramClient, errors
from telethon.sessions import StringSession
from telethon.tl.types import UserStatusOnline, InputPhoneContact
from telethon.tl.functions.contacts import ImportContactsRequest
from quart import Quart, render_template_string, request, redirect, session, Response, url_for
import aiosqlite
import python_socks
import hypercorn.asyncio
from hypercorn.config import Config
import pytz
import httpx
from datetime import datetime

# --- CONFIGURATION (Render Friendly) ---
API_ID = int(os.environ.get("API_ID", 9497762))
API_HASH = os.environ.get("API_HASH", "272c77bf080e4a82846b8ff3dc3df0f4")
SESSION_STRING = os.environ.get("SESSION_STRING", None)
AUTO_TARGETS = os.environ.get("AUTO_TARGETS", "") 

DB_FILE = 'tracker.db'
PIC_FOLDER = 'static/profile_pics'
POLL_INTERVAL = 10
SELF_PING_URL = os.environ.get("RENDER_EXTERNAL_URL", "http://localhost:5000")

os.makedirs(PIC_FOLDER, exist_ok=True)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger("Tracker")

app = Quart(__name__, static_folder='static')
app.secret_key = secrets.token_hex(16)

# Locks & Semaphores
db_lock = asyncio.Lock()
api_sem = asyncio.Semaphore(5)

class AppState:
    def __init__(self):
        self.client = None
        self.db = None
        self.tg_logged_in = False
        self.status = "Initializing..."
        self.memory = {} 
        self.running = True

state = AppState()

# --- DATABASE ---
async def init_db():
    state.db = await aiosqlite.connect(DB_FILE)
    state.db.row_factory = aiosqlite.Row
    await state.db.execute('CREATE TABLE IF NOT EXISTS targets (id INTEGER PRIMARY KEY, user_id INT UNIQUE, name TEXT, status TEXT, last_seen REAL, pic TEXT)')
    await state.db.execute('CREATE TABLE IF NOT EXISTS sessions (id INTEGER PRIMARY KEY, user_id INT, status TEXT, start REAL, end REAL, dur TEXT)')
    await state.db.execute('CREATE TABLE IF NOT EXISTS app_config (key TEXT PRIMARY KEY, value TEXT)')
    
    # Default Web Admin Credentials
    if not await db_query("SELECT value FROM app_config WHERE key='admin_user'", fetch="val"):
        await db_query("INSERT INTO app_config VALUES ('admin_user', 'admin')", commit=True)
        await db_query("INSERT INTO app_config VALUES ('admin_pass', 'admin')", commit=True)
    
    await state.db.commit()
    logger.info("‚úÖ Database initialized")

async def db_query(sql, args=(), commit=False, fetch="all"):
    if not state.db: return None
    async with db_lock:
        try:
            cursor = await state.db.execute(sql, args)
            if commit: await state.db.commit()
            if fetch == "one": return await cursor.fetchone()
            if fetch == "all": return await cursor.fetchall()
            if fetch == "val": 
                res = await cursor.fetchone()
                return res[0] if res else None
        except Exception as e:
            logger.error(f"DB Error: {e}")
            return None

# --- HELPERS ---
def format_ts(ts, minimal=True):
    if not ts: return "Never"
    try:
        dt = datetime.fromtimestamp(ts, pytz.timezone('Asia/Kolkata'))
        now = datetime.now(pytz.timezone('Asia/Kolkata'))
        if minimal and dt.date() == now.date():
            return dt.strftime('%I:%M %p')
        return dt.strftime('%d-%b %I:%M %p')
    except: return "-"

def calc_dur(start_ts, end_ts):
    try:
        if not start_ts or not end_ts: return "-"
        seconds = int(end_ts - start_ts)
        if seconds < 60: return "Just now"
        m, s = divmod(seconds, 60)
        h, m = divmod(m, 60)
        if h > 0: return f"{h}h {m}m"
        return f"{m}m {s}s"
    except: return "-"

async def get_chart_data(uid):
    """Generates hourly data for Chart.js"""
    hourly = [0] * 24
    rows = await db_query("SELECT start FROM sessions WHERE user_id = ? ORDER BY id DESC LIMIT 100", (uid,))
    if rows:
        for r in rows:
            try:
                dt = datetime.fromtimestamp(r['start'], pytz.timezone('Asia/Kolkata'))
                hourly[dt.hour] += 1
            except: pass
    return hourly

async def get_insight(uid):
    hourly = await get_chart_data(uid)
    if sum(hourly) == 0: return "No sufficient data yet."
    peak_hour = hourly.index(max(hourly))
    dt = datetime.now().replace(hour=peak_hour, minute=0)
    return f"Most active around {dt.strftime('%I %p')}"

async def safe_api_call(coroutine):
    async with api_sem:
        try:
            return await coroutine
        except errors.FloodWaitError as e:
            logger.warning(f"üåä FloodWait: Sleeping {e.seconds}s...")
            await asyncio.sleep(e.seconds)
            return await safe_api_call(coroutine)
        except Exception: return None

async def download_pic(user):
    try:
        if state.client and state.client.is_connected():
            p = await state.client.download_profile_photo(user, file=PIC_FOLDER)
            return os.path.basename(p) if p else "default.png"
    except: pass
    return "default.png"

# --- CORE ENGINE ---
async def init_client():
    sess_str = await db_query("SELECT value FROM app_config WHERE key='tg_session'", fetch="val")
    # Fallback to Env Var (for Render Persistence)
    if not sess_str: sess_str = os.environ.get("SESSION_STRING", None)

    if sess_str:
        try:
            state.client = TelegramClient(StringSession(sess_str), API_ID, API_HASH)
            await state.client.connect()
            if await state.client.is_user_authorized():
                state.tg_logged_in = True
                state.status = "Active"
                logger.info("‚úÖ Telegram Connected")
        except: pass
    
    if not state.client:
        state.client = TelegramClient(StringSession(), API_ID, API_HASH)
        await state.client.connect()

async def restore_targets():
    if not state.tg_logged_in or not AUTO_TARGETS: return
    for t in [x.strip() for x in AUTO_TARGETS.split(',') if x.strip()]:
        await add_target_logic(t)

async def add_target_logic(u):
    try:
        e = None
        # Safe Resolve (Username/ID only)
        try: e = await safe_api_call(state.client.get_entity(int(u) if u.lstrip('-').isdigit() else u))
        except: pass
        
        if e:
            pic = await download_pic(e)
            name = getattr(e, 'first_name', '') or getattr(e, 'username', '') or str(u)
            if getattr(e, 'last_name', None): name += f" {e.last_name}"
            
            await db_query('INSERT OR IGNORE INTO targets (user_id, name, status, last_seen, pic) VALUES (?,?,?,?,?)', (e.id, name, '...', time.time(), pic), commit=True)
    except: pass

async def tracker_loop():
    while not state.tg_logged_in:
        state.status = "Waiting for Telegram Login..."
        await asyncio.sleep(2)
    
    await restore_targets()
    state.status = "Monitoring"
    logger.info("üöÄ Tracker V36 Engine Started")
    last_flush = time.time()

    while state.running:
        try:
            if not state.client or not state.client.is_connected():
                await state.client.connect()
                await asyncio.sleep(5); continue

            targets = await db_query('SELECT user_id, name FROM targets')
            if not targets: await asyncio.sleep(POLL_INTERVAL); continue

            for t in targets:
                uid, name = t['user_id'], t['name']
                try:
                    u = await safe_api_call(state.client.get_entity(uid))
                    if not u: continue 
                    
                    is_online = isinstance(u.status, UserStatusOnline)
                    stat = 'online' if is_online else 'offline'
                    now_ts = time.time()

                    if stat != state.memory.get(uid):
                        await db_query('UPDATE targets SET status=?, last_seen=? WHERE user_id=?', (stat, now_ts, uid), commit=True)
                        
                        if stat == 'online':
                            await db_query('INSERT INTO sessions (user_id, status, start) VALUES (?,?,?)', (uid, 'ONLINE', now_ts), commit=True)
                            await safe_api_call(state.client.send_message('me', f"üü¢ <b>{name}</b> is ONLINE", parse_mode='html'))
                        
                        elif state.memory.get(uid) == 'online':
                            last_sess = await db_query('SELECT id, start FROM sessions WHERE user_id=? AND end IS NULL ORDER BY id DESC LIMIT 1', (uid,), fetch="one")
                            if last_sess:
                                dur = calc_duration(last_sess['start'], now_ts)
                                await db_query('UPDATE sessions SET end=?, dur=? WHERE id=?', (now_ts, dur, last_sess['id']), commit=True)
                        
                        state.memory[uid] = stat
                    
                    elif time.time() - last_flush > 300: # Heartbeat every 5 mins
                        await db_query('UPDATE targets SET last_seen=? WHERE user_id=?', (now_ts, uid), commit=True)
                        
                except: pass
                await asyncio.sleep(0.1)
            
            if time.time() - last_flush > 300: last_flush = time.time()
            await asyncio.sleep(POLL_INTERVAL)
            
        except Exception as e:
            logger.error(f"Loop Crash: {e}")
            await asyncio.sleep(POLL_INTERVAL)

async def keep_alive():
    while state.running:
        await asyncio.sleep(600)
        try: async with httpx.AsyncClient() as h: await h.get(SELF_PING_URL)
        except: pass

# --- GOD MODE UI TEMPLATES ---
STYLE = """
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    * { box-sizing: border-box; }
    body { background: #0f172a; font-family: 'Inter', sans-serif; margin: 0; padding: 0; color: white; display: flex; flex-direction: column; min-height: 100vh; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
    .auth-card { padding: 40px; border-radius: 24px; width: 100%; max-width: 400px; }
    .title { text-align: center; font-size: 1.8rem; font-weight: 800; margin-bottom: 30px; background: linear-gradient(to right, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .input { width: 100%; padding: 15px; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; color: white; margin-bottom: 20px; font-size: 16px; outline:none; transition:0.3s; }
    .input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    .btn { width: 100%; padding: 15px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; transition:0.2s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
    .nav { position: sticky; top: 0; z-index: 50; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
    .container { padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px 0; }
    .card { border-radius: 20px; padding: 20px; transition: 0.3s; position: relative; overflow: hidden; }
    .card:hover { transform: translateY(-5px); border-color: #3b82f6; }
    .avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid #334155; }
    .avatar.online { border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
    .status-badge { font-size: 0.7rem; font-weight: 800; padding: 5px 12px; border-radius: 20px; background: #334155; display: inline-block; letter-spacing: 0.5px; }
    .status-badge.online { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .fab { position:fixed; bottom:30px; right:30px; background:#3b82f6; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:white; text-decoration:none; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5); transition: 0.3s; z-index: 100; }
    .fab:hover { transform: scale(1.1) rotate(90deg); }
    .menu-link { color: #94a3b8; margin-left: 20px; font-size: 1.2rem; transition: 0.2s; }
    .menu-link:hover { color: white; }
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
"""

P_LOGIN = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="auth-container"><div class="glass auth-card">
    <div class="title"><i class="fa-solid fa-shield-halved"></i> Admin Access</div>
    {% if error %}<div style="color:#f87171; text-align:center; margin-bottom:15px;">{{ error }}</div>{% endif %}
    <form action="/do_web_login" method="post">
        <input type="text" name="username" class="input" placeholder="Username" required>
        <input type="password" name="password" class="input" placeholder="Password" required>
        <button class="btn">Unlock Dashboard</button>
    </form>
</div></div></body></html>"""

P_TG_CONNECT = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="auth-container"><div class="glass auth-card">
    <div class="title"><i class="fa-brands fa-telegram"></i> Connect Engine</div>
    <p style="text-align:center; color:#94a3b8; margin-bottom:30px;">Enter your phone number to initialize the tracking bot.</p>
    <form action="/send_otp" method="post">
        <input type="text" name="ph" class="input" placeholder="+91..." required>
        <button class="btn" style="background:#0ea5e9">Send OTP</button>
    </form>
</div></div></body></html>"""

P_TG_VERIFY = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="auth-container"><div class="glass auth-card">
    <div class="title">üîê Verify Access</div>
    <p style="text-align:center; color:#94a3b8; margin-bottom:30px;">Check your Telegram app for the code.</p>
    <form action="/verify_otp" method="post">
        <input type="hidden" name="ph" value="{{ ph }}">
        <input type="hidden" name="hash" value="{{ hash }}">
        <input type="hidden" name="session_str" value="{{ session_str }}">
        <input type="text" name="code" class="input" placeholder="1 2 3 4 5" style="text-align:center; letter-spacing:8px; font-size:1.2rem;" required>
        <button class="btn" style="background:#10b981">Start Engine</button>
    </form>
</div></div></body></html>"""

P_DASH = """<!DOCTYPE html><html><head>""" + STYLE + """<meta http-equiv="refresh" content="{{ refresh }}"></head><body>
<div class="nav glass">
    <div style="font-weight:800; font-size:1.2rem; background:linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
        <i class="fa-solid fa-radar"></i> ProTracker
    </div>
    <div>
        <a href="/profile" class="menu-link"><i class="fa-solid fa-gear"></i></a>
        <a href="/logout" class="menu-link" style="color:#ef4444;"><i class="fa-solid fa-power-off"></i></a>
    </div>
</div>
<div class="container">
    {% if not tg_active %}
    <a href="/connect_telegram" style="display:block; background:rgba(245, 158, 11, 0.1); border:1px solid rgba(245, 158, 11, 0.5); color:#fbbf24; padding:15px; border-radius:12px; text-align:center; text-decoration:none; font-weight:bold; margin-bottom:20px; backdrop-filter:blur(5px);">
        <i class="fa-solid fa-triangle-exclamation"></i> Tracker Engine Disconnected. Click to Reconnect.
    </a>
    {% endif %}
    
    <div class="grid">
        {% for t in targets %}
        <a href="/target/{{ t.user_id }}" style="text-decoration:none; color:inherit;">
            <div class="glass card">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img src="/static/profile_pics/{{ t.pic }}" class="avatar {{ 'online' if t.status == 'online' else '' }}" onerror="this.src='/static/profile_pics/default.png'">
                    <div>
                        <div style="font-weight:700; font-size:1.1rem;">{{ t.name }}</div>
                        <div class="status-badge {{ 'online' if t.status == 'online' else '' }}">{{ t.status.upper() }}</div>
                    </div>
                </div>
                <div style="margin-top:20px; display:flex; justify-content:space-between; font-size:0.85rem; color:#94a3b8; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px;">
                    <span><i class="fa-regular fa-clock"></i> Last Seen</span>
                    <span style="color:white; font-family:monospace;">{{ t.last_seen_fmt }}</span>
                </div>
            </div>
        </a>
        {% else %}
        <div style="grid-column:1/-1; text-align:center; padding:60px; color:#64748b;">
            <i class="fa-solid fa-ghost" style="font-size:3rem; margin-bottom:20px; opacity:0.5;"></i><br>
            No targets found. Tap the + button to add one.
        </div>
        {% endfor %}
    </div>
</div>
<a href="/add_page" class="fab"><i class="fa-solid fa-plus"></i></a>
</body></html>"""

P_DETAIL = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="nav glass">
    <a href="/" style="color:white; text-decoration:none; font-weight:600;"><i class="fa-solid fa-arrow-left"></i> Back</a>
</div>
<div class="container">
    <div class="glass card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px;">
        <div style="display:flex; align-items:center; gap:20px;">
            <img src="/static/profile_pics/{{ t.pic }}" class="avatar" style="width:80px; height:80px; border-radius:20px;" onerror="this.src='/static/profile_pics/default.png'">
            <div>
                <h1 style="margin:0; font-size:1.8rem; font-weight:800;">{{ t.name }}</h1>
                <div style="color:#94a3b8; font-family:monospace; margin-top:5px;">ID: {{ t.user_id }}</div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
             <a href="/export/{{ t.user_id }}" class="btn" style="width:auto; display:inline-block; padding:12px 20px; background:#10b981;"><i class="fa-solid fa-download"></i> CSV</a>
             <a href="/delete/{{ t.user_id }}" class="btn" style="width:auto; display:inline-block; padding:12px 20px; background:#ef4444;" onclick="return confirm('Stop tracking this user?')"><i class="fa-solid fa-trash"></i></a>
        </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="glass card">
            <h3 style="color:#94a3b8; font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">AI Insight</h3>
            <div style="font-size:1.1rem; color:#60a5fa; font-weight:600;"><i class="fa-solid fa-lightbulb"></i> {{ insight }}</div>
        </div>
        <div class="glass card">
            <h3 style="color:#94a3b8; font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">Current Status</h3>
            <div style="font-size:1.1rem; font-weight:600; color: {{ '#4ade80' if t.status=='online' else '#94a3b8' }}">{{ t.status.upper() }}</div>
        </div>
    </div>

    <div class="glass card" style="margin-top:0;">
        <h3 style="margin-top:0; margin-bottom:20px;">Activity Heatmap (Hourly)</h3>
        <div style="height:250px;"><canvas id="chart"></canvas></div>
    </div>

    <div class="glass card" style="margin-top:20px;">
        <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px; margin-bottom:15px;">Recent Sessions</h3>
        {% for s in sessions %}
        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.95rem;">
            <div><span style="color:#10b981; margin-right:10px;">‚óè</span> {{ s.start_fmt }}</div>
            <div style="color:#94a3b8; font-family:monospace;">{{ s.dur }}</div>
        </div>{% endfor %}
    </div>
</div>
<script>
new Chart(document.getElementById('chart'), {
    type: 'bar',
    data: { 
        labels: Array.from({length:24},(_,i)=> (i<10?'0':'')+i+':00'), 
        datasets: [{ 
            label: 'Sessions', 
            data: {{ chart_data }}, 
            backgroundColor: 'rgba(59, 130, 246, 0.8)', 
            borderRadius: 6,
            borderSkipped: false
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        scales: { 
            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, 
            x: { grid: { display: false } } 
        }, 
        plugins: { legend: { display: false } } 
    }
});
</script></body></html>"""

P_ADD = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="nav glass"><a href="/" style="color:white; text-decoration:none;"><i class="fa-solid fa-xmark"></i> Cancel</a></div>
<div class="auth-container"><div class="glass auth-card">
    <div class="title">Add Target</div>
    <p style="text-align:center; color:#ef4444; font-size:0.9rem; margin-bottom:20px; background:rgba(239,68,68,0.1); padding:10px; border-radius:8px;">
        <i class="fa-solid fa-shield-cat"></i> Stealth Mode Active<br>Only Usernames or IDs allowed.
    </p>
    <form action="/add_target" method="post">
        <label style="color:#94a3b8; font-size:0.9rem; margin-left:5px;">Identifier</label>
        <input type="text" name="u" class="input" placeholder="@username or 12345678" required>
        <button class="btn">Start Tracking</button>
    </form>
</div></div></body></html>"""

P_PROFILE = """<!DOCTYPE html><html><head>""" + STYLE + """</head><body>
<div class="nav glass"><a href="/" style="color:white; text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> Back</a></div>
<div class="container"><div class="glass card" style="max-width:500px; margin:0 auto;">
    <h2 style="text-align:center; margin-bottom:30px;">Admin Settings</h2>
    <form action="/update_admin" method="post">
        <label style="color:#94a3b8; font-size:0.9rem; margin-left:5px;">Update Password</label>
        <input type="password" name="pw" class="input" placeholder="New Password (leave empty to keep)">
        <button class="btn" style="background:#334155">Save Changes</button>
    </form>
</div></div></body></html>"""

# --- 8. ROUTES ---
@app.before_request
def guard():
    if request.path.startswith('/static'): return
    if request.path in ['/web_login', '/do_web_login']: return
    if 'admin_user' not in session: return redirect('/web_login')

@app.route('/web_login')
async def web_login(): return await render_template_string(P_LOGIN, error=request.args.get('error'))

@app.route('/do_web_login', methods=['POST'])
async def do_web_login():
    f = await request.form
    u, p = f['username'], f['password']
    db_u = await db_query("SELECT value FROM app_config WHERE key='admin_user'", fetch="val")
    db_p = await db_query("SELECT value FROM app_config WHERE key='admin_pass'", fetch="val")
    if u == db_u and p == db_p:
        session['admin_user'] = u
        return redirect('/')
    return redirect('/web_login?error=Invalid Credentials')

@app.route('/logout')
async def logout():
    session.clear()
    return redirect('/web_login')

@app.route('/connect_telegram')
async def connect_telegram(): return await render_template_string(P_TG_CONNECT)

@app.route('/send_otp', methods=['POST'])
async def send_otp():
    try:
        temp = TelegramClient(StringSession(), API_ID, API_HASH)
        await temp.connect()
        ph = (await request.form)['ph']
        s = await temp.send_code_request(ph)
        ses = StringSession.save(temp.session)
        await temp.disconnect()
        return await render_template_string(P_TG_VERIFY, ph=ph, hash=s.phone_code_hash, session_str=ses)
    except Exception as e: return f"Error: {e} <a href='/connect_telegram'>Back</a>"

@app.route('/verify_otp', methods=['POST'])
async def verify_otp():
    f = await request.form
    try:
        c = TelegramClient(StringSession(f['session_str']), API_ID, API_HASH)
        await c.connect()
        await c.sign_in(f['ph'], f['code'], phone_code_hash=f['hash'])
        
        final_sess = StringSession.save(c.session)
        print("\n" + "="*50 + "\n‚úÖ COPY SESSION:\n" + final_sess + "\n" + "="*50 + "\n")
        
        await db_query("INSERT OR REPLACE INTO app_config (key, value) VALUES ('tg_session', ?)", (final_sess,), commit=True)
        await c.disconnect()
        await init_client() 
        return redirect('/')
    except Exception as e: return f"Error: {e} <a href='/connect_telegram'>Retry</a>"

@app.route('/')
async def index():
    rows = await db_query("SELECT * FROM targets ORDER BY CASE WHEN status='online' THEN 0 ELSE 1 END, name ASC")
    targets = []
    for r in rows:
        d = dict(r)
        d['last_seen_fmt'] = format_ts(d['last_seen'])
        targets.append(d)
    return await render_template_string(P_DASH, targets=targets, tg_active=state.tg_logged_in, refresh=POLL_INTERVAL)

@app.route('/target/<int:uid>')
async def target_detail(uid):
    t_row = await db_query("SELECT * FROM targets WHERE user_id=?", (uid,), fetch="one")
    if not t_row: return redirect('/')
    
    sess_rows = await db_query("SELECT * FROM sessions WHERE user_id=? ORDER BY id DESC LIMIT 20", (uid,))
    sessions = []
    for s in sess_rows:
        sd = dict(s)
        sd['start_fmt'] = format_ts(sd['start'], minimal=False)
        sessions.append(sd)
        
    chart_data = await get_chart_data(uid)
    insight = await get_insight(uid)
    return await render_template_string(P_DETAIL, t=dict(t_row), sessions=sessions, chart_data=chart_data, insight=insight)

@app.route('/add_page')
async def add_page(): return await render_template_string(P_ADD)

@app.route('/add_target', methods=['POST'])
async def add_target():
    await add_target_logic((await request.form)['u'])
    return redirect('/')

@app.route('/delete/<int:uid>')
async def delete(uid):
    await db_query('DELETE FROM targets WHERE user_id = ?', (uid,), commit=True)
    return redirect('/')

@app.route('/export/<int:uid>')
async def export_csv(uid):
    async with aiosqlite.connect(DB_FILE) as db:
        async with db.execute('SELECT * FROM sessions WHERE user_id = ? ORDER BY id DESC', (uid,)) as c:
            rows = await c.fetchall()
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(['Session ID', 'User ID', 'Status', 'Start Time', 'End Time', 'Duration'])
    writer.writerows(rows)
    return Response(output.getvalue(), mimetype="text/csv", headers={"Content-Disposition": f"attachment; filename=log_{uid}.csv"})

@app.route('/profile')
async def profile(): return await render_template_string(P_PROFILE)

@app.route('/update_admin', methods=['POST'])
async def update_admin():
    pw = (await request.form)['pw']
    if pw:
        await db_query("UPDATE app_config SET value=? WHERE key='admin_pass'", (pw,), commit=True)
    return redirect('/')

@app.after_serving
async def shutdown():
    state.running = False
    if state.client: await state.client.disconnect()
    if state.db: await state.db.close()

@app.before_serving
async def startup():
    await init_db()
    await init_client()
    app.add_background_task(tracker_loop)
    app.add_background_task(keep_alive)

if __name__ == '__main__':
    config = Config()
    config.bind = [f"0.0.0.0:{int(os.environ.get('PORT', 5000))}"]
    asyncio.run(hypercorn.asyncio.serve(app, config))
